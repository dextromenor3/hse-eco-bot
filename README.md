# hse-eco-bot
Бот написан на языке Rust. Для разработки и запуска необходимо установить компилятор
[по инструкции](https://www.rust-lang.org/tools/install). Также необходимо
установить `cargo` (как правило, поставляется и устанавливаеися вместе с компилятором).
Рекомендуется использование Unix-подобной среды для сборки и запуска: Linux, macOS,
Windows Subsystem for Linux (WSL2), MSYS2 или Cygwin.

## Получение токена
Для работы бота необходимо получить токен Telegram.
Для этого необходимо обратиться к боту `@BotFather` и действовать
по его инструкции. В итоге должен получиться токен вида:
```
1234567890:ABCDEF1234567890abcdefghijklmn
```
Это секретный токен, с помощью которого можно совершать действия от имени бота.
Боту требуется предоставить данный токен при запуске, что описано ниже.

## Сборка
Зайти в директорию с ботом и запустить команду `cargo build` (из терминала или
командной строки). Если компилятор Rust правильно установлен, она скачает и
скомпилирует зависимости бота, а также скомпилирует его код. В дальнейшем нужно
выполнять эту команду для сборки изменённого кода бота.
Исполняемый файл будет лежать по адресу `target/debug/hse-eco-bot`
(или `hse-eco-bot.exe`).

Финальную версию бота рекомендуется собирать командой `cargo build --release`.

## Развёртывание базы данных
Перед запуском нужно хотя бы один раз развернуть базу данных. Для этого необходимо запустить скрипт
`scripts/install.py`. Для выполнения потребуется Python 3.

## Запуск
Для начала, необходимо определить следующие переменные окружения:

- `HSE_ECO_BOT_TOKEN`: токен, полученный от `@BotFather`.
- `HSE_ECO_BOT_ADMIN` (необязательно): имя пользователя (без символа "`@`"), которому бот предоставит
  права на редактирование базы знаний и администрирование бота. Это временная заглушка, которую
  следует заменить на полноценную систему привелегий.
- `RUST_LOG` (необязательно): уровень логирования. Удобно для отладки. Рекомендуемое значение:
  "`info,hse_eco_bot=trace`" (без кавычек).

Для того, чтобы определить переменную с именем `NAME` и значением `VALUE` нужно выполнить команды (до того,
как запустить бота):

В командной строке (`cmd.exe`):
```
set NAME=VALUE
```

В Unix-подобной среде:
```
export NAME=VALUE
```

Данные переменные действуют до закрытия командной строки или терминала.

Запустить бота можно командой:
```
cargo run
```

## Обзор кода

- `hse-eco-bot-macros`: Вспомогательные макросы для кода бота. Как правило, изменений не требуется.
- `kb`: Начальное содержимое базы знаний.
- `scripts`: Скрипты для администраторов.
  - `install.py`: Скрипт для развёртывания базы данных.
- `resources/strings.yml`: Описание строк с текстом в формате YAML. Читается на этапе компиляции,
  для выполнения бота этот файл не нужен.
- `hse-eco-bot/src`: Основной код бота.
  - `main.rs`, `app.rs`: Точка входа.
  - `ui.rs`: Взаимодействие бота с пользователем.
  - `state.rs`: Описание состояний, в которых может находиться бот.
  - `callback_query.rs`: Описание callback-запросов при нажатиях на кнопки.
  - `newsletter/*`, `newsletter.rs`: Рассылки сообщений.
  - `kb/*`, `kb.rs`: База знаний и вспомогательные структуры.
    - `providers/db/*`, `providers/db.rs`: Хранение в базе данных.
  - etc.
- `target`: Временные файлы сборки. Генерируется автоматически компилятором, редактировать не нужно.

Большинство строк и шаблонов сообщений хранится в файле `resources/strings.yml`. Если по ключу
`["foo"]["bar"]` записана строка `"Hello"`, то из кода доступ к ней можно получить через
`STRINGS.foo.bar()`. Если указан шаблон строки, например `"Hello, {}!"`, то можно получить
эту строку с подстановкой шаблона как `STRINGS.foo.bar(name)`. Подробнее об этом можно
узнать на примерах в `hse-eco-bot/src/ui.rs`.
